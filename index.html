<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ–‡ä»¶æå–å·¥å…·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    .row {
      display: flex;
      margin-bottom: 20px;
    }
    .col {
      flex: 1;
      padding: 0 10px;
    }
    .file-explorer {
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 400px;
      overflow: auto;
    }
    

    .file-explorer-header {
      padding: 10px;
      background-color: #f1f1f1;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
    }
    .file-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .file-item {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .file-item:hover {
      background-color: #f9f9f9;
    }
    .file-item.selected {
      background-color: #e3f2fd;
    }
    .file-item-icon {
      margin-right: 8px;
      color: #666;
    }
    .folder-icon::before {
      content: "ğŸ“";
    }
    .file-icon::before {
      content: "ğŸ“„";
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .path-display {
      padding: 10px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
      white-space: nowrap;
      overflow: auto;
    }
    .selected-items-container {
      height: 400px;
      display: flex;
      flex-direction: column;
    }
    .selected-items-header {
      font-weight: bold;
      padding: 10px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
    }
    .selected-items {
      flex-grow: 1; /* è‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ */
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 0 0 4px 4px;
    }
    .selected-item {
      padding: 5px;
      background-color: #f1f1f1;
      margin-bottom: 5px;
      border-radius: 3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .remove-btn {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      padding: 2px 5px;
      font-size: 12px;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    .error {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    .hidden {
      display: none;
    }
    .breadcrumb {
      padding: 8px 0;
      margin-bottom: 10px;
      list-style: none;
      background-color: #f5f5f5;
      border-radius: 4px;
      display: flex;
      flex-wrap: wrap;
    }
    .breadcrumb-item {
      display: inline-block;
      padding: 0 5px;
      cursor: pointer;
      color: #0275d8;
    }
    .breadcrumb-item:hover {
      text-decoration: underline;
    }
    .breadcrumb-separator {
      color: #666;
    }
    .back-btn {
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      color: #333;
      padding: 5px 10px;
      margin-right: 5px;
      border-radius: 3px;
    }
    .back-btn:hover {
      background-color: #e1e1e1;
    }
    
    /* ä¸Šä¸‹æ–‡èœå•æ ·å¼ */
    .context-menu {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 150px;
    }
    
    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    
    .context-menu-item:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ–‡ä»¶æå–å·¥å…·</h1>
    
    <div class="buttons">
      <button id="selectBaseDirBtn">é€‰æ‹©åŸºç¡€æ–‡ä»¶å¤¹</button>
      <button id="clearSelectionsBtn">æ¸…é™¤æ‰€æœ‰é€‰æ‹©</button>
      <button id="generateMdBtn" disabled>ç”ŸæˆMDæ–‡ä»¶</button>
    </div>
    
    <div id="baseDirDisplay" class="path-display hidden">
      å½“å‰åŸºç¡€æ–‡ä»¶å¤¹: <span id="basePathText"></span>
    </div>
    
    <div class="row">
      <div class="col">
        <div class="file-explorer">
          <div class="file-explorer-header">æ–‡ä»¶æµè§ˆå™¨</div>
          <div class="breadcrumb" id="breadcrumb">
            <button class="back-btn" id="backBtn" disabled>â†‘ è¿”å›ä¸Šçº§</button>
            <div id="breadcrumbPath"></div>
          </div>
          <ul id="fileList" class="file-list">
            <li>è¯·å…ˆé€‰æ‹©åŸºç¡€æ–‡ä»¶å¤¹</li>
          </ul>
        </div>
      </div>
      <div class="col">
        <div class="selected-items-container">
          <div class="selected-items-header">å·²é€‰æ‹©çš„æ–‡ä»¶/æ–‡ä»¶å¤¹:</div>
          <div id="selectedItemsList" class="selected-items">
            <div>æœªé€‰æ‹©ä»»ä½•é¡¹ç›®</div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="statusMessage" class="status hidden"></div>
  </div>
  
  <script>
    const { ipcRenderer } = require('electron');
    const path = require('path');
    const fs = require('fs');
    
    // å…ƒç´ å¼•ç”¨
    const selectBaseDirBtn = document.getElementById('selectBaseDirBtn');
    const clearSelectionsBtn = document.getElementById('clearSelectionsBtn');
    const generateMdBtn = document.getElementById('generateMdBtn');
    const baseDirDisplay = document.getElementById('baseDirDisplay');
    const basePathText = document.getElementById('basePathText');
    const fileList = document.getElementById('fileList');
    const selectedItemsList = document.getElementById('selectedItemsList');
    const statusMessage = document.getElementById('statusMessage');
    const breadcrumb = document.getElementById('breadcrumb');
    const breadcrumbPath = document.getElementById('breadcrumbPath');
    const backBtn = document.getElementById('backBtn');
    
    // çŠ¶æ€å˜é‡
    let basePath = null;
    let currentPath = null;
    const selectedItems = new Set();
    let pathHistory = [];
    
    // é€‰æ‹©åŸºç¡€æ–‡ä»¶å¤¹
    selectBaseDirBtn.addEventListener('click', async () => {
      const selectedDir = await ipcRenderer.invoke('select-base-dir');
      if (selectedDir) {
        basePath = selectedDir;
        currentPath = selectedDir;
        pathHistory = [selectedDir];
        
        // æ¸…é™¤å·²é€‰æ‹©çš„æ‰€æœ‰é¡¹ç›®
        selectedItems.clear();
        updateSelectedItemsList();
        updateGenerateButtonState();
        
        basePathText.textContent = basePath;
        baseDirDisplay.classList.remove('hidden');
        
        await loadDirectoryContents(currentPath);
        updateBreadcrumb();
      }
    });
    
    // æ¸…é™¤æ‰€æœ‰é€‰æ‹©çš„æŒ‰é’®
    clearSelectionsBtn.addEventListener('click', () => {
      if (selectedItems.size > 0) {
        selectedItems.clear();
        updateSelectedItemsList();
        updateGenerateButtonState();
        
        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨ä¸­çš„é€‰æ‹©çŠ¶æ€
        const currentFileItems = fileList.querySelectorAll('.file-item');
        currentFileItems.forEach(fileItem => {
          fileItem.classList.remove('selected');
        });
        
        showStatus(true, 'å·²æ¸…é™¤æ‰€æœ‰é€‰æ‹©');
      }
    });
    
    // ç”ŸæˆMDæ–‡ä»¶
    generateMdBtn.addEventListener('click', async () => {
      try {
        if (selectedItems.size === 0) {
          showStatus(false, 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
          return;
        }
        
        // é€‰æ‹©ä¿å­˜MDæ–‡ä»¶çš„ä½ç½®
        const result = await ipcRenderer.invoke('show-save-dialog', {
          title: 'ä¿å­˜MDæ–‡ä»¶',
          buttonLabel: 'ä¿å­˜',
          filters: [{ name: 'Markdown', extensions: ['md'] }],
          defaultPath: path.join(basePath, 'extracted-files.md')
        });
        
        const { canceled, filePath } = result;
        if (!canceled && filePath) {
          // è°ƒç”¨ä¸»è¿›ç¨‹å¤„ç†
          const genResult = await ipcRenderer.invoke('generate-md', {
            basePath: basePath,
            selectedItems: Array.from(selectedItems),
            outputFilePath: filePath
          });
          
          // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
          showStatus(genResult.success, genResult.message);
        }
      } catch (error) {
        showStatus(false, `å‘ç”Ÿé”™è¯¯: ${error.message}`);
      }
    });
    
    // è¿”å›ä¸Šä¸€çº§ç›®å½•
    backBtn.addEventListener('click', async () => {
      if (pathHistory.length > 1) {
        pathHistory.pop(); // ç§»é™¤å½“å‰è·¯å¾„
        currentPath = pathHistory[pathHistory.length - 1];
        await loadDirectoryContents(currentPath);
        updateBreadcrumb();
      }
    });
    
    // åŠ è½½ç›®å½•å†…å®¹
    async function loadDirectoryContents(dirPath) {
      try {
        const result = await ipcRenderer.invoke('get-directory-contents', dirPath);
        
        if (result.success) {
          // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
          fileList.innerHTML = '';
          
          if (result.items.length === 0) {
            const emptyItem = document.createElement('li');
            emptyItem.textContent = '(ç©ºæ–‡ä»¶å¤¹)';
            fileList.appendChild(emptyItem);
          } else {
            // å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹ï¼Œå†æ˜¾ç¤ºæ–‡ä»¶
            const folders = result.items.filter(item => item.isDirectory);
            const files = result.items.filter(item => !item.isDirectory);
            
            [...folders, ...files].forEach(item => {
              const li = document.createElement('li');
              li.className = 'file-item';
              
              // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
              if (selectedItems.has(item.path)) {
                li.classList.add('selected');
              }
              
              const icon = document.createElement('span');
              icon.className = item.isDirectory ? 'file-item-icon folder-icon' : 'file-item-icon file-icon';
              
              const name = document.createElement('span');
              name.textContent = item.name;
              
              li.appendChild(icon);
              li.appendChild(name);
              
              // æ·»åŠ ç‚¹å‡»äº‹ä»¶
              li.addEventListener('click', async (e) => {
                if (item.isDirectory) {
                  // è¿›å…¥å­ç›®å½•
                  currentPath = item.path;
                  pathHistory.push(currentPath);
                  await loadDirectoryContents(currentPath);
                  updateBreadcrumb();
                } else {
                  // é€‰æ‹©æˆ–å–æ¶ˆé€‰æ‹©æ–‡ä»¶
                  toggleSelection(item.path);
                  li.classList.toggle('selected');
                }
              });
              
              // æ·»åŠ å³é”®èœå•äº‹ä»¶
              li.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                
                if (item.isDirectory) {
                  // ä¸ºæ–‡ä»¶å¤¹åˆ›å»ºä¸Šä¸‹æ–‡èœå•
                  const menu = document.createElement('div');
                  menu.className = 'context-menu';
                  menu.style.position = 'absolute';
                  menu.style.left = `${e.pageX}px`;
                  menu.style.top = `${e.pageY}px`;
                  menu.style.zIndex = 1000;
                  
                  const selectItem = document.createElement('div');
                  selectItem.className = 'context-menu-item';
                  selectItem.textContent = 'é€‰æ‹©/å–æ¶ˆé€‰æ‹©';
                  selectItem.onclick = () => {
                    toggleSelection(item.path);
                    li.classList.toggle('selected');
                    document.body.removeChild(menu);
                  };
                  
                  const selectEntireFolder = document.createElement('div');
                  selectEntireFolder.className = 'context-menu-item';
                  selectEntireFolder.textContent = 'é€‰æ‹©æ•´ä¸ªæ–‡ä»¶å¤¹';
                  selectEntireFolder.onclick = async () => {
                    await selectFolder(item.path);
                    document.body.removeChild(menu);
                  };
                  
                  menu.appendChild(selectItem);
                  menu.appendChild(selectEntireFolder);
                  document.body.appendChild(menu);
                  
                  // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                  document.addEventListener('click', function closeMenu() {
                    if (document.body.contains(menu)) {
                      document.body.removeChild(menu);
                    }
                    document.removeEventListener('click', closeMenu);
                  });
                } else {
                  // æ™®é€šæ–‡ä»¶ä»…åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                  toggleSelection(item.path);
                  li.classList.toggle('selected');
                }
              });
              
              fileList.appendChild(li);
            });
          }
          
          // æ›´æ–°è¿”å›æŒ‰é’®çŠ¶æ€
          backBtn.disabled = pathHistory.length <= 1;
        } else {
          showStatus(false, result.message);
        }
      } catch (error) {
        showStatus(false, `åŠ è½½ç›®å½•å†…å®¹å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
    function updateBreadcrumb() {
      breadcrumbPath.innerHTML = '';
      
      if (!basePath || !currentPath) return;
      
      let relative = path.relative(basePath, currentPath);
      let parts = relative === '' ? [] : relative.split(path.sep);
      let currentParentPath = basePath;
      
      // æ·»åŠ æ ¹ç›®å½•é¡¹
      const rootItem = document.createElement('span');
      rootItem.className = 'breadcrumb-item';
      rootItem.textContent = path.basename(basePath);
      rootItem.addEventListener('click', async () => {
        currentPath = basePath;
        pathHistory = [basePath];
        await loadDirectoryContents(currentPath);
        updateBreadcrumb();
      });
      breadcrumbPath.appendChild(rootItem);
      
      // æ·»åŠ æ¯ä¸€çº§å­ç›®å½•
      for (let i = 0; i < parts.length; i++) {
        // æ·»åŠ åˆ†éš”ç¬¦
        const separator = document.createElement('span');
        separator.className = 'breadcrumb-separator';
        separator.textContent = ' / ';
        breadcrumbPath.appendChild(separator);
        
        const part = parts[i];
        currentParentPath = path.join(currentParentPath, part);
        
        const pathItem = document.createElement('span');
        pathItem.className = 'breadcrumb-item';
        pathItem.textContent = part;
        
        const pathToNavigate = currentParentPath;
        pathItem.addEventListener('click', async () => {
          // æ‰¾åˆ°å½“å‰è·¯å¾„åœ¨å†å²ä¸­çš„ä½ç½®
          const index = pathHistory.indexOf(pathToNavigate);
          if (index !== -1) {
            // æˆªæ–­å†å²åˆ°è¯¥ä½ç½®
            pathHistory = pathHistory.slice(0, index + 1);
          } else {
            // å¦‚æœä¸åœ¨å†å²ä¸­ï¼Œæ·»åŠ åˆ°å†å²
            pathHistory.push(pathToNavigate);
          }
          
          currentPath = pathToNavigate;
          await loadDirectoryContents(currentPath);
          updateBreadcrumb();
        });
        
        breadcrumbPath.appendChild(pathItem);
      }
    }
    
    // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
    function toggleSelection(itemPath) {
      const isAlreadySelected = selectedItems.has(itemPath);
      
      if (isAlreadySelected) {
        selectedItems.delete(itemPath);
      } else {
        selectedItems.add(itemPath);
      }
      
      updateSelectedItemsList();
      updateGenerateButtonState();
    }
    
    // æ›´æ–°å·²é€‰æ‹©çš„é¡¹ç›®åˆ—è¡¨
    function updateSelectedItemsList() {
      selectedItemsList.innerHTML = '';
      
      if (selectedItems.size === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.textContent = 'æœªé€‰æ‹©ä»»ä½•é¡¹ç›®';
        selectedItemsList.appendChild(emptyMsg);
        return;
      }
      
      Array.from(selectedItems).forEach(itemPath => {
        const item = document.createElement('div');
        item.className = 'selected-item';
        
        const itemText = document.createElement('span');
        // æ˜¾ç¤ºç›¸å¯¹äºåŸºç¡€ç›®å½•çš„è·¯å¾„
        const relativePath = path.relative(basePath, itemPath);
        itemText.textContent = relativePath || path.basename(itemPath);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = 'åˆ é™¤';
        removeBtn.onclick = () => {
          selectedItems.delete(itemPath);
          updateSelectedItemsList();
          updateGenerateButtonState();
          
          // å¦‚æœå½“å‰åœ¨æµè§ˆè¯¥é¡¹æ‰€åœ¨çš„ç›®å½•ï¼Œæ›´æ–°æ–‡ä»¶åˆ—è¡¨ä¸­çš„é€‰æ‹©çŠ¶æ€
          const currentFileItems = fileList.querySelectorAll('.file-item');
          currentFileItems.forEach(fileItem => {
            const fileName = fileItem.querySelector('span:last-child').textContent;
            const filePath = path.join(currentPath, fileName);
            if (filePath === itemPath) {
              fileItem.classList.remove('selected');
            }
          });
        };
        
        item.appendChild(itemText);
        item.appendChild(removeBtn);
        selectedItemsList.appendChild(item);
      });
    }
    
    // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
    function updateGenerateButtonState() {
      generateMdBtn.disabled = selectedItems.size === 0;
    }
    
    // é€’å½’é€‰æ‹©æ–‡ä»¶å¤¹åŠå…¶å†…å®¹
    async function selectFolder(folderPath) {
      try {
        // é¦–å…ˆé€‰æ‹©æ–‡ä»¶å¤¹æœ¬èº«
        selectedItems.add(folderPath);
        
        // å–å¾—æ–‡ä»¶å¤¹å†…å®¹
        const result = await ipcRenderer.invoke('get-directory-contents', folderPath);
        
        if (result.success) {
          for (const item of result.items) {
            if (item.isDirectory) {
              // é€’å½’å¤„ç†å­æ–‡ä»¶å¤¹
              await selectFolder(item.path);
            } else {
              // é€‰æ‹©æ–‡ä»¶
              selectedItems.add(item.path);
            }
          }
        }
        
        // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
        updateSelectedItemsList();
        updateGenerateButtonState();
        
        // å¦‚æœå½“å‰æ­£åœ¨æµè§ˆæ–‡ä»¶å¤¹ï¼Œæ›´æ–°æ–‡ä»¶é¡¹çš„é€‰ä¸­çŠ¶æ€
        if (currentPath === folderPath) {
          const currentFileItems = fileList.querySelectorAll('.file-item');
          currentFileItems.forEach(fileItem => {
            const fileName = fileItem.querySelector('span:last-child').textContent;
            const filePath = path.join(currentPath, fileName);
            if (selectedItems.has(filePath)) {
              fileItem.classList.add('selected');
            }
          });
        }
        
        return true;
      } catch (error) {
        showStatus(false, `é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`);
        return false;
      }
    }
    
    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(success, message) {
      statusMessage.textContent = message;
      statusMessage.className = success ? 'status success' : 'status error';
      statusMessage.classList.remove('hidden');
      
      // 5ç§’åéšè—çŠ¶æ€ä¿¡æ¯
      setTimeout(() => {
        statusMessage.classList.add('hidden');
      }, 5000);
    }
  </script>
</body>
</html>
